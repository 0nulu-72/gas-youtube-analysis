# YouTube 分析スプレッドシート (GAS)

Google Apps Script (GAS) を使って YouTube Data API v3 を呼び出し、検索結果を取得・集計・可視化するスプレッドシート用ツールです。  
以下の手順で導入すれば、キーワードを変更しながら各種動画指標をスプレッドシート上で手軽に比較・グラフ化できます。

---

## 目次

1. [概要](#概要)  
2. [デモスプレッドシート](#デモスプレッドシート)  
3. [前提条件](#前提条件)  
4. [シート構成](#シート構成)  
5. [GAS セットアップ](#gas-セットアップ)  
6. [使い方](#使い方)  
7. [主要ロジックの流れ](#主要ロジックの流れ)  
8. [シート・セルの詳細](#シート・セルの詳細)  
9. [出力イメージ](#出力イメージ)  
10. [カスタマイズ例](#カスタマイズ例)  
11. [ライセンス](#ライセンス)  

---

## 概要

1. スプレッドシート上部に追加されたメニュー「YouTube 分析」→「検索実行」をクリック  
2. シート「検索」に入力した検索キーワードや各種フィルターをもとに YouTube Data API を呼び出し  
3. 取得した動画リストをもとに統計情報（再生数・高評価数・コメント数・チャンネル登録者数）を取得  
4. 「検索結果」シートに動画データ一覧を出力  
5. 「グラフ」シートで上位 5 件のエンゲージメント率・急上昇率・再生数÷チャンネル登録者数をバーグラフ化  

---

## デモスプレッドシート

以下のリンクをコピーしてご自身の Google ドライブに複製し、動作をお試しください。  
- [YouTube 分析スプレッドシート（サンプル）](https://docs.google.com/spreadsheets/d/1ATV0duGxNLsyNpCsyTtkh5kvAM86cZpvxfuhMTal50k/edit?usp=sharing)  

---

## 前提条件

- Google アカウント  
- Google スプレッドシート  
- YouTube Data API v3 の有効化と認証情報（API キーまたは OAuth2 クライアント情報）  
  1. Google Cloud Console で YouTube Data API v3 を有効化  
  2. スクリプトエディタ → 「サービスを追加」から **YouTube Data API** を追加  
  3. `appsscript.json` に下記のような OAuth スコープが含まれていることを確認  
     ```json
     {
       "oauthScopes": [
         "https://www.googleapis.com/auth/script.external_request",
         "https://www.googleapis.com/auth/spreadsheets",
         "https://www.googleapis.com/auth/youtube.readonly"
       ]
     }
     ```

---

## シート構成

以下 3 枚のシートを用意します。**シート名は変更しないでください**。

1. **検索**  
   - キーワードや抽出条件などを入力するシート  
2. **検索結果**  
   - API から取得した動画一覧を出力するシート  
   - 実行時に自動で作成・クリア  
3. **グラフ**  
   - 上位 5 件の “エンゲージメント率” “急上昇率” “再生数÷チャンネル登録者数” をバーグラフ化  
   - 実行時に自動で作成・クリア  

---

## GAS セットアップ

1. スプレッドシートを開き、メニュー **「拡張機能」→「Apps Script」** を選択してスクリプトエディタを起動  
2. 新規プロジェクトが開いたら、`Code.gs` など任意のファイル名で以下のリポジトリ内のスクリプトファイルをコピーして保存  
   - **リポジトリ例**: `コード.js`（長いロジック部分）  
   - 詳細なコードはリポジトリに置き、README では表示を省略しています  
3. スクリプトエディタ上部の **「サービスを追加」** ボタン（+アイコン）をクリックし、**YouTube Data API** をプロジェクトに追加  
4. 必要に応じて **「プロジェクトの設定」→「スクリプトのプロパティ」** に API キーや OAuth2 情報を登録（本サンプルでは直接埋め込んでいません）  
5. `onOpen()` 関数を一度手動実行するか、スプレッドシートを再読み込みして **「YouTube分析」** メニューが表示されることを確認  

---

## 使い方

1. **シート「検索」に入力**  
   下表を参考に、B2～B8 のセルに必要項目を入力してください。  
   | セル | 項目                 | 内容／選択肢                                   | 例                        |
   |:----:|:--------------------|:----------------------------------------------|:--------------------------|
   | B2   | 検索キーワード       | 必須。キーワードを入力                         | `猫 動画`                  |
   | B3   | 抽出条件             | ドロップダウン推奨。`関連度` / `再生回数` / `投稿日` | `再生回数`                |
   | B4   | 抽出件数 (maxResults)| 数字のみ。API 制限に注意                         | `10`                      |
   | B5   | 対象期間フィルタ       | ドロップダウン推奨。`今週` / `今月` / `今年` / （空欄：全期間） | `今月`                    |
   | B6   | 並び替え基準         | ドロップダウン推奨。`再生回数` / `高評価数` / `コメント数` / `投稿日` | `コメント数`              |
   | B7   | 動画長フィルタ         | ドロップダウン推奨。`4分未満` / `4分以上20分未満` / `20分以上` / `時間指定なし` | `4分以上20分未満`         |
   | B8   | 優先地域フィルタ       | ドロップダウン推奨。`日本` / `全世界`               | `日本`                    |

   - **B2 (キーワード)** が空だと処理が中断されます。必ず入力してください。  
   - B3～B8 は入力ミスを防ぐためにあらかじめドロップダウンリストを設定しておくと便利です。  

2. **メニュー「YouTube分析」→「検索実行」をクリック**  
   - スプレッドシート上部に表示された **「YouTube分析」** → **「検索実行」** をクリックすると、自動で以下の処理が行われます：  
     1. YouTube Data API を呼び出し、動画リストを取得  
     2. `processVideos()` で各動画の統計情報を取得  
     3. 「検索結果」シートにデータ一覧を出力  
     4. 「グラフ」シートに上位 5 件の各種指標をバーグラフで描画  
   - 完了後、ダイアログで「検索結果を”検索結果”シートに出力し、グラフを”グラフ”シートに作成しました。」と表示されます。  

3. **結果を確認**  
   - **検索結果シート**：No. / タイトル / URL / 投稿日 / チャンネル名 / 概要 / エンゲージメント率 / 急上昇率 / 再生数÷登録者数  
   - **グラフシート**：各トップ 5 のバーグラフが表示される  

4. **定期実行トリガー（任意）**  
   - Apps Script エディタ → **時計アイコン（トリガー）** → `searchYouTube` を毎朝 8:00 など任意の間隔で実行  

---

## 主要ロジックの流れ

- **onOpen()**  
  - シート起動時にメニュー **「YouTube分析」** を追加  

- **searchYouTube()**  
  1. 「検索」シートから B2～B8 の値を取得  
  2. 抽出条件・動画長・地域フィルタを API パラメータに変換  
  3. `YouTube.Search.list()` で動画リストを取得  
  4. `processVideos()` で `YouTube.Videos.list()` を呼び出し、各動画の統計情報（視聴回数・高評価数・コメント数・チャンネル登録者数）を整形  
  5. `sortVideos()` で指定基準（再生回数 / 高評価 / コメント / 投稿日）に並び替え  
  6. `getOrCreateSheet()` で「検索結果」「グラフ」シートを用意し、  
     - `outputResults()` で検索結果をシートに書き込み  
     - `configureChartData()` → `createBarChart()` で上位 5 件の各種指標をバーグラフで生成  

- **getPublishedAfterDate(filter)**  
  - 「今週」「今月」「今年」に応じた ISO 8601 日付文字列を返す  

- **processVideos(items)**  
  - 検索結果の動画 ID をまとめて `YouTube.Videos.list()` で取得し、  
    `title` / `url` / `publishedAt` / `channelTitle` / `description` / `viewCount` / `likeCount` / `commentCount` / `subscriberCount` の配列を返す  

- **getChannelSubscribers(channelId)**  
  - `YouTube.Channels.list('statistics', { id: channelId })` を使ってチャンネル登録者数を取得  

- **sortVideos(videos, sortCondition)**  
  - 引数 `sortCondition`（再生回数 / 高評価数 / コメント数 / 投稿日）でソートを実行  

- **getOrCreateSheet(ss, sheetName)**  
  - 指定シートがなければ作成、あれば既存内容をクリアして返す  

- **outputResults(videos, sheet)**  
  1. ヘッダー行を設定  
  2. 各動画データを二次元配列にしてシートに書き込み  
  3. 上位 5 件を抽出し、`configureChartData()` を呼び出してグラフ描画  

- **calculateEngagementRate(video)** / **calculateTrendingRate(video)** / **calculateViewSubRatio(video)**  
  - 各指標（エンゲージメント率・急上昇率・再生数÷登録者数）を計算して文字列で返す  

- **configureChartData(sheet, title, data, hAxisTitle, startRow, startCol)**  
  1. ヘッダーを配置  
  2. データ行を配置  
  3. データ中の「No.」に対して A 列に `HYPERLINK()` 数式を埋め込み（「検索結果シート」へジャンプ）  
  4. `createBarChart()` でバーグラフを生成  
  5. 次のグラフ開始行を返す  

- **createBarChart(sheet, startRow, endRow, title, hAxisTitle, positionRow, positionCol)**  
  - 与えられた範囲をもとにバーグラフを生成し、指定位置に挿入  

---

## シート・セルの詳細

### 検索シート

| セル | 項目                 | 説明・制約                                |
|:----:|:--------------------|:-----------------------------------------|
| B2   | 検索キーワード       | 必須。空白の場合、アラートで停止。       |
| B3   | 抽出条件             | ドロップダウン推奨。<br>関連度 / 再生回数 / 投稿日 |
| B4   | 抽出件数 (maxResults)| 数字のみ。API 制限に注意。               |
| B5   | 対象期間フィルタ       | ドロップダウン推奨。<br>今週 / 今月 / 今年 / （空白: 全期間） |
| B6   | 並び替え基準         | ドロップダウン推奨。<br>再生回数 / 高評価数 / コメント数 / 投稿日 |
| B7   | 動画長フィルタ         | ドロップダウン推奨。<br>4分未満 / 4分以上20分未満 / 20分以上 / 指定なし |
| B8   | 優先地域フィルタ       | ドロップダウン推奨。<br>日本 / 全世界      |

### 検索結果シート

- 実行時に自動作成またはクリア  
- カラム構成（1行目ヘッダー / 2行目以降データ）  
  1. No.  
  2. タイトル  
  3. URL  
  4. 投稿日  
  5. チャンネル名  
  6. 概要  
  7. エンゲージメント率  
  8. 急上昇率  
  9. 再生数 ÷ チャンネル登録者数  

### グラフシート

- 実行時に自動作成またはクリア  
- 「エンゲージメント率トップ5」「急上昇率トップ5」「再生数÷チャンネル登録者数トップ5」それぞれに：  
  1. 左カラムに「No.」「タイトル」「数値」のテーブル  
  2. 右に対応するバーグラフを配置  

---

## 出力イメージ

1. **検索結果シート（一部）**  
   | No. | タイトル               | URL                      | 投稿日      | チャンネル名 | … |
   |:--:|:-----------------------|:-------------------------|:-----------|:-------------|---|
   | 1  | 猫のかわいい動画       | https://youtu.be/xxxxx   | 2025/01/01 | 猫チャンネル | … |
   | 2  | おもしろ猫ハプニング   | https://youtu.be/yyyyy   | 2025/02/15 | 動物ニュース | … |

2. **グラフシート（一部）**  
   - **エンゲージメント率トップ5** のバーグラフ  
   - **急上昇率トップ5** のバーグラフ  
   - **再生数÷チャンネル登録者数トップ5** のバーグラフ  

---

## カスタマイズ例

- **定期実行トリガー**  
  - Apps Script エディタ → **時計アイコン（トリガー）** → `searchYouTube` を毎日 8:00 に実行  

- **セル位置を変更したい場合**  
  - コード中の `getRange('B2')` や `getRange('B3')` などを必要に応じて修正し、README の該当箇所も更新  

- **追加指標の導入**  
  1. `processVideos()` に新しいプロパティを追加（例：再生時間など）  
  2. `outputResults()` のヘッダー・出力ロジックを拡張  
  3. `configureChartData()` に新たなチャート生成ロジックを追加  

---

## ライセンス

MIT License  
詳しくは [LICENSE](LICENSE) ファイルを参照してください。
